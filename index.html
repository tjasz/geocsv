<!DOCTYPE html>
<html lang="en">
<head>
	
	<title>MP Companion</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>

  <!-- Load jQuery and PapaParse to read data from a CSV file -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

	<link rel="stylesheet" href="index.css">

	
</head>
<body>

<div id="top">
  <div id="map"></div>
  <div id="preview">
    <iframe id="preview-frame" src=""></iframe>
  </div>
</div>
<div id="table">
  <table id="data-table">
  </table>
</div>

<script src="algorithm.js"></script>
<script src="mapview.js"></script>
<script src="frameview.js"></script>
<script src="tableview.js"></script>
<script src="datamodel.js"></script>

<script>


function removeAllChildNodes(parent) {
    while (parent.firstChild) {
        parent.removeChild(parent.firstChild);
    }
}

function formatData(data) {
  // if null, return empty string
  if (null === data) return "";
  // if a number, return its repr
  if (typeof data === 'number') {
    return data;
  }
  // if a valid URL, make it a link
  try {
    url = new URL(data);
    return "<a target='_blank' href='" + data + "'>Link</a>";
  } catch (_) {
    // if a MP location, split
    var location = "";
    var hierarchy = data.split('>');
    for (var i in hierarchy) {
      if (hierarchy[i] === " City of Rocks ") {
        return location;
      }
      if (i > 0) location += " > ";
      location += hierarchy[i];
    }
    return data;
  }
}

// associate a Leaflet marker with a data row/object
function addMarker(item) {
  // build the marker
  var title = formatData(item["Location"]);
  var popup = formatData(item["Location"]);
  var marker = L.marker([item["Area Latitude"], item["Area Longitude"]], {
    opacity: 1,
    title: title
  }).bindPopup(popup);
  // add it to the object
  item.marker = marker;
}
// add markers to the CSV objects
function addMarkers(data) {
  // For each row in data, create a marker and add it to the row/object
  for (var i in data) {
    var row = data[i];
    addMarker(row);
  }
}

// --------------------------------------------------
// all use of globals should be limited to below here
// --------------------------------------------------
function focus(row) {
  //mapview.flyTo(row.marker);
  frameview.goToRoute(row.URL);
  tableview.highlight(row.URL);
}
// refresh data in all views; to be called if change to data, filtering, or sorting
function refresh() {
  mapview.clear();
  mapview.addData(datamodel.filteredData);
  mapview.resetZoom();
  
  frameview.goHome();
  
  tableview.clear();
  tableview.addRows(datamodel.filteredData, focus, mapview.boundsPredicate.bind(mapview));
}
function sortby(field) {
  datamodel.sortBy(field);
  tableview.clear();
  tableview.addRows(datamodel.filteredData, focus, mapview.boundsPredicate.bind(mapview));
}

var mapview = new MapView();
var frameview = new FrameView("preview-frame", connect=false);
var tableview = new TableView("data-table");
var globalPredicate = function(item) {
  var scary = ("string" === typeof item.Rating) && (item.Rating.includes("PG13") || item.Rating.includes("R") || item.Rating.includes("X"));
  var easy = item.Rating >= "5.6" && item.Rating < "5.9";
  var good = item["Avg Stars"] > 2;
  var popular = !Number.isInteger(item["Avg Stars"]);
  return good && popular && !scary && easy && item["Route Type"] === "Trad";
  };
var datamodel;

// set mapview move listener
mapview.map.on('moveend', function(e) {
  tableview.clear();
  tableview.addRows(datamodel.filteredData, focus, mapview.boundsPredicate.bind(mapview));
  });

// Read markers data from CSV, populate views
$.get('city-of-rocks.csv', function(csvString) {

  // Use PapaParse to convert string to array of objects
  var result = Papa.parse(csvString, {header: true, dynamicTyping: false});
  datamodel = new DataModel(result.data);
  datamodel.filter(globalPredicate);
  // associate markers with each data row/object
  addMarkers(datamodel.filteredData);
  
  mapview.addData(datamodel.filteredData);
  
  tableview.addHeader(datamodel.keys);
  tableview.addRows(datamodel.filteredData, focus, mapview.boundsPredicate.bind(mapview));
});

</script>



</body>
</html>
