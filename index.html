
<!DOCTYPE html>
<html lang="en">
<head>
	
	<title>MP Companion</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>

  <!-- Load jQuery and PapaParse to read data from a CSV file -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
      float: left;
			height: 800px;
			width: 50%;
			max-height: 70%;
		}
    #preview {
      float: left;
			height: 800px;
			width: 50%;
			max-height: 70%;
    }
    #preview-frame {
      top:0px;
      left:0px;
      width:100%;
      height:100%;
      border: none;
      overflow: hidden;
    }
	</style>

	
</head>
<body>
<h1>MP Companion</h1>

<div id="top">
  <div id="map"></div>
  <div id="preview">
    <iframe id="preview-frame" src=""></iframe>
  </div>
</div>
<div id="table">
  <table id="data-table">
  </table>
</div>





<script>

function* filter(data, predicate = function(item) { return true; }) {
  if (null === data) return null;
  for (let item of data) {
    if (predicate(item)) yield item;
  }
}

function removeAllChildNodes(parent) {
    while (parent.firstChild) {
        parent.removeChild(parent.firstChild);
    }
}

function formatData(data) {
  // if null, return empty string
  if (null === data) return "";
  // if a number, return its repr
  if (typeof data === 'number') {
    return data;
  }
  // if a valid URL, make it a link
  try {
    url = new URL(data);
    return "<a target='_blank' href='" + data + "'>Link</a>";
  } catch (_) {
    // if a MP location, split
    var location = "";
    var hierarchy = data.split('>');
    for (var i in hierarchy) {
      if (hierarchy[i] === " City of Rocks ") {
        return location;
      }
      if (i > 0) location += " > ";
      location += hierarchy[i];
    }
    return data;
  }
}

// associate a Leaflet marker with a data row/object
function addMarker(item) {
  // build the marker
  var title = formatData(item["Location"]);
  var popup = formatData(item["Location"]);
  var marker = L.marker([item["Area Latitude"], item["Area Longitude"]], {
    opacity: 1,
    title: title
  }).bindPopup(popup);
  // add it to the object
  item.marker = marker;
}
// add markers to the CSV objects
function addMarkers(data) {
  // For each row in data, create a marker and add it to the row/object
  for (var i in data) {
    var row = data[i];
    addMarker(row);
  }
}

// MapView object for managing the map view
function MapView() {
  var outdoorLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidGphc3oiLCJhIjoiY2wxcDQ4eG1pMHZxNDNjcGM3djJ4eGphMCJ9.aH-D5oeZHZVzcWQZeeRviQ', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/outdoors-v11',
		tileSize: 512,
		zoomOffset: -1
	});
  var satelliteLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidGphc3oiLCJhIjoiY2wxcDQ4eG1pMHZxNDNjcGM3djJ4eGphMCJ9.aH-D5oeZHZVzcWQZeeRviQ', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/satellite-v9',
		tileSize: 512,
		zoomOffset: -1
	});
  var baseMaps = {
    "Outdoor": outdoorLayer,
    "Satellite": satelliteLayer
  };
	this.map = L.map('map').setView([42.0809,-113.70743], 12);
  this.markers = L.featureGroup().addTo(this.map);
  L.control.layers(baseMaps).addTo(this.map);
  outdoorLayer.addTo(this.map);
}
MapView.prototype.flyTo = function(marker) {
  this.map.flyTo(marker.getLatLng(), 18);
  marker.openPopup();
};
MapView.prototype.resetZoom = function() {
  this.map.fitBounds(this.markers.getBounds());
};
MapView.prototype.clear = function() {
  this.markers.clearLayers();
};
MapView.prototype.addData = function(data, predicate = function(item) { return true; }) {
  for (let row of filter(data, predicate)) {
    this.markers.addLayer(row.marker);
  }
};
MapView.prototype.boundsPredicate = function(item) {
  var bounds = this.map.getBounds();
  return item["Area Latitude"] <= bounds.getNorth() &&
         item["Area Latitude"] >= bounds.getSouth() &&
         item["Area Longitude"] >= bounds.getWest() &&
         item["Area Longitude"] <= bounds.getEast();
};

// The frame viewer
function FrameView(elementId, connect) {
  // toggle "connected" so you don't hammer MP's server whiel testing
  this.connected = connect;
  this.frame = document.getElementById(elementId);
  this.goHome();
}
FrameView.prototype.goHome = function() {
  if (this.connected) {
    this.frame.setAttribute('src', "https://www.mountainproject.com/area/105739322/city-of-rocks");
  }
};
FrameView.prototype.goToRoute = function(url) {
  if (this.connected) {
    this.frame.setAttribute('src', url);
  }
};

// Table viewer
function TableView(elementId) {
  this.table = document.getElementById(elementId);
}
TableView.prototype.clear = function() {
  removeAllChildNodes(this.table);
  this.addHeader(this.fields);
}
TableView.prototype.addHeader = function(fields) {
  this.fields = fields;
  var tr = this.table.insertRow(0);
  for (let field of fields) {
    var th = document.createElement('th');
    th.innerHTML = field;
    tr.appendChild(th);
  }
}
TableView.prototype.addRow = function(row) {
  tr = this.table.insertRow(-1);
  for (let field of this.fields) {
    var td = tr.insertCell(-1);
    td.innerHTML = formatData(row[field]);
  }
  // set row onclick listener
  (function(row) { tr.onclick = function(){
    focus(row);
  }; })(row);
}
TableView.prototype.addRows = function(rows, predicate = function(item) { return true; }) {
  if (null === rows) return;
  for (let row of filter(rows, predicate)) {
    this.addRow(row);
  }
};
TableView.prototype.highlight = function(url) {
  // TODO highlight the selected row
  //for (let tr of this.table.firstElementChild.children) {
  //  console.log(tr);
  //}
};

// --------------------------------------------------
// all use of globals should be limited to below here
// --------------------------------------------------
function focus(row) {
  mapview.flyTo(row.marker);
  frameview.goToRoute(row.URL);
  tableview.highlight(row.URL);
}

var mapview = new MapView();
var frameview = new FrameView("preview-frame", connect=false);
var tableview = new TableView("data-table");
var globalPredicate = function(item) { return true; };
var data;

// set mapview move listener
mapview.map.on('moveend', function(e) {
  tableview.clear();
  tableview.addRows(filter(data, globalPredicate), mapview.boundsPredicate.bind(mapview));
  });

// Read markers data from CSV, populate views
$.get('city-of-rocks.csv', function(csvString) {

  // Use PapaParse to convert string to array of objects
  var result = Papa.parse(csvString, {header: true, dynamicTyping: true});
  data = result.data;
  // associate markers with each data row/object
  addMarkers(data);
  
  mapview.addData(data);
  
  tableview.addHeader(result.meta['fields']);
  tableview.addRows(data);
});

</script>



</body>
</html>
